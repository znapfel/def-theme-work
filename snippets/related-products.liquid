{%- assign RELATED_PRODUCTS_LIMIT = 4 -%}
{%- if product.metafields.theme.related_products != blank-%}
    {%- comment -%}
    Product Recommendations based on Metafields
    {%- endcomment -%}
    {%- assign related_product_handles = product.metafields.theme.related_products | split: ',' -%}
    {%- for related_product_handle in related_product_handles -%}
    {%- comment -%}
    TODO Add a way to render this or just remove it?
    {%- endcomment -%}
    {%- endfor -%}

    {%- else -%} 

        {%- assign related_collection_handle = product.handle | append '-related' -%}
        {%- assign related_collection = collections[related_collection_handle] -%}
        {%- comment -%}
        If a related collection exists and has products in it, 
        generate a recommendation product collection from that collection
        {%- endcomment -%}
        {%- if related_collection and related_collection.products.size > 0 %}
            {%- for related_product in related_collection.products limit: RELATED_PRODUCTS_LIMIT -%}
            {%- comment -%}
            TODO Add a way to render this or just remove it?
            {%- endcomment -%}
            {%- endfor -%}

        {%- else -%}
        {%- comment -%}
        Look through all other collections the current product is in 
        and use that collection to generate the related products.
        {%- endcomment -%}
            {%- assign related_collection = nil -%}
            {%- for collection in product.collections -%}
                {%- unless collection.handle == 'all' -%}
                {%- if related_collection == blank or collection.products.size > related_collection.products.size -%}
                    {%- assign related_collection = collection -%}
                    {%- if related_collection.products.size > 5 -%}
                        {%- break -%}
                    {%- endif -%}
                {%- endif -%}
                {%- endunless -%}
            {%- endfor -%}

            {%- for related_product in related_collection.products limit: RELATED_PRODUCTS_LIMIT -%}
            {%- comment -%}
            TODO Add a way to render this or just remove it?
            {%- endcomment -%}
            {%- endfor -%}

        {%- endif -%}
    {%- endif -%}